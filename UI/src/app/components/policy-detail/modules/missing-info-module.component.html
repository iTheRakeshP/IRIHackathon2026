<div class="missing-info-module">
  <!-- Header -->
  <div class="module-header">
    <div class="header-content">
      <mat-icon color="accent">assignment_late</mat-icon>
      <div class="header-text">
        <h3>{{ alert.title }}</h3>
        <p class="reason-short">{{ alert.reasonShort }}</p>
      </div>
    </div>
    <button 
      mat-icon-button 
      class="ai-assist-btn" 
      (click)="onAskAI()" 
      matTooltip="Ask PolicyPilot">
      <mat-icon>psychology</mat-icon>
    </button>
  </div>

  <mat-divider></mat-divider>

  <!-- Critical Missing Fields Summary -->
  <div class="critical-fields-summary">
    <h4><mat-icon>priority_high</mat-icon> Critical Missing Information</h4>
    <div class="field-chips">
      <mat-chip *ngFor="let field of getCriticalMissingFields()" class="missing-chip">
        <mat-icon>error_outline</mat-icon>
        {{ field.label }}
      </mat-chip>
    </div>
    <p class="last-updated">
      <mat-icon>schedule</mat-icon>
      {{ getLastUpdatedText() }}
    </p>
  </div>

  <mat-divider></mat-divider>

  <!-- Auto-Applied Information Banner -->
  <div class="auto-apply-banner">
    <mat-icon>cloud_done</mat-icon>
    <div>
      <strong>Owner information will be auto-applied from account profile</strong>
      <p>Name, SSN, Address, Email, and Phone will be synchronized automatically upon submission.</p>
    </div>
  </div>

  <!-- Update Form with Expansion Panels -->
  <form [formGroup]="updateForm" class="update-form-accordion">
    
    <mat-accordion [multi]="true">
      
      <!-- Primary Beneficiary Section -->
      <mat-expansion-panel [expanded]="isPrimaryBeneficiaryMissing()" class="form-panel">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon [color]="isPrimaryBeneficiaryMissing() ? 'warn' : 'primary'">person</mat-icon>
            <span>Primary Beneficiary</span>
            <mat-chip *ngIf="isPrimaryBeneficiaryMissing()" class="required-badge">Required</mat-chip>
          </mat-panel-title>
          <mat-panel-description>
            {{ getPrimaryBeneficiaryStatus() }}
          </mat-panel-description>
        </mat-expansion-panel-header>

        <div formGroupName="primaryBeneficiary" class="panel-content">
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>Full Name</mat-label>
              <input matInput formControlName="name" required>
              <mat-icon matSuffix>person</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Relationship</mat-label>
              <mat-select formControlName="relationship" required>
                <mat-option *ngFor="let rel of relationshipOptions" [value]="rel">
                  {{ rel }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Allocation %</mat-label>
              <input matInput type="number" formControlName="allocationPercent" required min="0" max="100">
              <span matSuffix>%</span>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>SSN / Tax ID</mat-label>
              <input matInput formControlName="ssn" placeholder="XXX-XX-XXXX">
              <mat-icon matSuffix>badge</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Date of Birth</mat-label>
              <input matInput type="date" formControlName="dateOfBirth">
              <mat-icon matSuffix>cake</mat-icon>
            </mat-form-field>
          </div>
        </div>
      </mat-expansion-panel>

      <!-- Contingent Beneficiary Section -->
      <mat-expansion-panel class="form-panel">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>people</mat-icon>
            <span>Contingent Beneficiary</span>
            <mat-chip class="optional-badge">Optional</mat-chip>
          </mat-panel-title>
          <mat-panel-description>
            {{ getContingentBeneficiaryStatus() }}
          </mat-panel-description>
        </mat-expansion-panel-header>

        <div formGroupName="contingentBeneficiary" class="panel-content">
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>Full Name</mat-label>
              <input matInput formControlName="name">
              <mat-icon matSuffix>person</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Relationship</mat-label>
              <mat-select formControlName="relationship">
                <mat-option *ngFor="let rel of relationshipOptions" [value]="rel">
                  {{ rel }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Allocation %</mat-label>
              <input matInput type="number" formControlName="allocationPercent" min="0" max="100">
              <span matSuffix>%</span>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>SSN / Tax ID</mat-label>
              <input matInput formControlName="ssn" placeholder="XXX-XX-XXXX">
              <mat-icon matSuffix>badge</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Date of Birth</mat-label>
              <input matInput type="date" formControlName="dateOfBirth">
              <mat-icon matSuffix>cake</mat-icon>
            </mat-form-field>
          </div>
        </div>
      </mat-expansion-panel>

      <!-- Tax Withholding Section -->
      <mat-expansion-panel [expanded]="isTaxWithholdingMissing()" class="form-panel">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon [color]="isTaxWithholdingMissing() ? 'warn' : 'primary'">receipt_long</mat-icon>
            <span>Tax Withholding Elections</span>
            <mat-chip *ngIf="isTaxWithholdingMissing()" class="required-badge">Required</mat-chip>
          </mat-panel-title>
          <mat-panel-description>
            {{ getTaxWithholdingStatus() }}
          </mat-panel-description>
        </mat-expansion-panel-header>

        <div formGroupName="taxWithholding" class="panel-content">
          <div class="form-grid-2col">
            <mat-form-field appearance="outline">
              <mat-label>Federal Withholding</mat-label>
              <input matInput type="number" formControlName="federal" min="0" max="100">
              <span matSuffix>%</span>
              <mat-hint>IRS recommended withholding</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>State Withholding</mat-label>
              <input matInput type="number" formControlName="state" min="0" max="100">
              <span matSuffix>%</span>
              <mat-hint>State tax if applicable</mat-hint>
            </mat-form-field>
          </div>
        </div>
      </mat-expansion-panel>

      <!-- Contact Information Section -->
      <mat-expansion-panel class="form-panel">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>contact_mail</mat-icon>
            <span>Contact Information</span>
            <mat-chip class="auto-badge">Auto-Applied</mat-chip>
          </mat-panel-title>
          <mat-panel-description>
            Pre-filled from account profile
          </mat-panel-description>
        </mat-expansion-panel-header>

        <div formGroupName="contactInfo" class="panel-content">
          <p class="info-note">
            <mat-icon>info</mat-icon>
            These fields are pre-filled from your account profile and will be automatically synchronized.
            You can update them if needed.
          </p>
          
          <div class="form-grid-2col">
            <mat-form-field appearance="outline">
              <mat-label>Email Address</mat-label>
              <input matInput type="email" formControlName="email">
              <mat-icon matSuffix>email</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Phone Number</mat-label>
              <input matInput type="tel" formControlName="phone">
              <mat-icon matSuffix>phone</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Mailing Address</mat-label>
              <input matInput formControlName="address">
              <mat-icon matSuffix>home</mat-icon>
            </mat-form-field>
          </div>
        </div>
      </mat-expansion-panel>

    </mat-accordion>

    <!-- Special Instructions -->
    <div class="special-instructions-section">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Special Instructions (Optional)</mat-label>
        <textarea matInput formControlName="specialInstructions" rows="2" placeholder="Add any special notes or instructions..."></textarea>
        <mat-icon matSuffix>note</mat-icon>
      </mat-form-field>
    </div>
  </form>

  <mat-divider></mat-divider>

  <!-- Submission Section -->
  <div class="submission-section">
    <!-- Success Message -->
    <div *ngIf="submitSuccess" class="success-message">
      <mat-icon>check_circle</mat-icon>
      <div>
        <h4>Policy Updated Successfully!</h4>
        <p>Changes have been recorded and will be processed.</p>
      </div>
    </div>

    <!-- Error Message -->
    <div *ngIf="submitError" class="error-message">
      <mat-icon>error</mat-icon>
      <p>{{ submitError }}</p>
    </div>

    <!-- Form Validation Warning -->
    <div *ngIf="updateForm.invalid && !validateAllocations()" class="validation-warning">
      <mat-icon>warning</mat-icon>
      <p>Please fill in all required fields. Allocation percentages must total 100%.</p>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button 
        mat-stroked-button 
        (click)="onSaveDraft()"
        [disabled]="isSubmitting || submitSuccess">
        <mat-icon>save</mat-icon>
        Save Draft
      </button>

      <button 
        mat-raised-button 
        color="primary"
        (click)="onSubmit()"
        [disabled]="isSubmitting || submitSuccess || updateForm.invalid || !validateAllocations()">
        <mat-spinner *ngIf="isSubmitting" diameter="20" class="button-spinner"></mat-spinner>
        <mat-icon *ngIf="!isSubmitting">send</mat-icon>
        {{ isSubmitting ? 'Submitting...' : 'Submit Updates' }}
      </button>
    </div>

    <div class="compliance-note">
      <mat-icon>verified_user</mat-icon>
      <p>Updates will be submitted via DTCC Administrative API for non-financial policy changes.</p>
    </div>
  </div>
</div>
