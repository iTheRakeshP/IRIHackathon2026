<div class="overflow-hidden rounded-xl bg-white shadow-md">
  <div class="flex items-start justify-between bg-gradient-to-br from-red-500 to-red-700 px-6 py-5 text-white">
    <div class="flex items-start gap-4">
      <mat-icon class="text-white !text-[32px] !w-8 !h-8">sync_alt</mat-icon>
      <div>
        <h3 class="m-0 mb-1 text-xl font-semibold">{{ alert.title }}</h3>
        <p class="m-0 text-sm opacity-95">{{ alert.reasonShort }}</p>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <button 
        mat-raised-button 
        class="!flex !items-center !gap-2 !rounded-full !bg-white !px-5 !py-0 !font-medium !text-red-700 !shadow-md transition-all hover:!shadow-lg"
        (click)="exportToPDF()"
        [disabled]="exportingPDF() || currentStep() !== 2 || alternatives().length === 0"
        matTooltip="Export complete analysis to PDF">
        <mat-icon class="!text-xl !w-5 !h-5">picture_as_pdf</mat-icon>
        @if (exportingPDF()) {
          <span>Generating PDF...</span>
        } @else {
          <span>Export to PDF</span>
        }
      </button>
      <button mat-icon-button class="!text-white" (click)="onAskAI()" matTooltip="Ask PolicyPilot">
        <mat-icon>psychology</mat-icon>
      </button>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Step Navigation -->
  <div class="flex items-center bg-slate-50 px-8 py-6">
    <div class="flex items-center gap-2" [class.opacity-50]="currentStep() !== 0 && currentStep() <= 0">
      <div class="flex h-8 w-8 items-center justify-center rounded-full text-sm font-semibold"
           [ngClass]="currentStep() === 0 ? 'bg-indigo-600 text-white' : currentStep() > 0 ? 'bg-green-500 text-white opacity-70' : 'bg-slate-200 text-slate-500'">1</div>
      <span class="whitespace-nowrap text-sm" [ngClass]="currentStep() === 0 ? 'font-semibold text-indigo-600' : 'text-slate-500'">Why Flagged</span>
    </div>
    <div class="mx-4 h-0.5 flex-1" [ngClass]="currentStep() > 0 ? 'bg-green-500' : 'bg-slate-200'"></div>
    <div class="flex items-center gap-2" [class.opacity-50]="currentStep() !== 1 && currentStep() <= 1">
      <div class="flex h-8 w-8 items-center justify-center rounded-full text-sm font-semibold"
           [ngClass]="currentStep() === 1 ? 'bg-indigo-600 text-white' : currentStep() > 1 ? 'bg-green-500 text-white opacity-70' : 'bg-slate-200 text-slate-500'">2</div>
      <span class="whitespace-nowrap text-sm" [ngClass]="currentStep() === 1 ? 'font-semibold text-indigo-600' : 'text-slate-500'">Verify Suitability</span>
    </div>
    <div class="mx-4 h-0.5 flex-1" [ngClass]="currentStep() > 1 ? 'bg-green-500' : 'bg-slate-200'"></div>
    <div class="flex items-center gap-2" [class.opacity-50]="currentStep() !== 2 && currentStep() <= 2">
      <div class="flex h-8 w-8 items-center justify-center rounded-full text-sm font-semibold"
           [ngClass]="currentStep() === 2 ? 'bg-indigo-600 text-white' : currentStep() > 2 ? 'bg-green-500 text-white opacity-70' : 'bg-slate-200 text-slate-500'">3</div>
      <span class="whitespace-nowrap text-sm" [ngClass]="currentStep() === 2 ? 'font-semibold text-indigo-600' : 'text-slate-500'">Review Alternatives</span>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Step 1: Why Flagged -->
  @if (currentStep() === 0) {
    <div class="px-8 py-6">
      <div class="mb-6 flex items-center gap-3">
        <mat-icon class="text-indigo-600 !text-[28px] !w-7 !h-7">flag</mat-icon>
        <h4 class="m-0 text-lg font-semibold text-slate-800">Why This Is Flagged</h4>
      </div>

      <div class="mb-6 rounded border-l-4 border-orange-500 bg-orange-50 px-5 py-4">
        @for (reason of alert.reasons; track reason) {
          <div class="mb-3 flex items-start gap-2 last:mb-0">
            <mat-icon class="mt-0.5 flex-shrink-0 text-orange-500 !text-xl !w-5 !h-5">chevron_right</mat-icon>
            <span class="flex-1 leading-relaxed text-slate-700">{{ reason }}</span>
          </div>
        }
      </div>

      <div class="mb-6 flex gap-3 rounded border-l-4 border-indigo-600 bg-indigo-50 px-5 py-4">
        <mat-icon class="flex-shrink-0 text-indigo-600 !text-2xl !w-6 !h-6">info</mat-icon>
        <div class="flex-1">
          <strong class="mb-2 block text-indigo-700">Compliance Context:</strong>
          <p class="m-0 text-sm leading-relaxed text-slate-700">Replacement reviews ensure that any recommended change is in the client's best interest and properly documented per regulatory requirements (FINRA Rule 2111, DOL Fiduciary Rule).</p>
        </div>
      </div>

      <mat-divider class="!my-5"></mat-divider>

      <!-- Next Step Preview -->
      <div class="mb-6 rounded-lg border-2 border-green-400 bg-gradient-to-br from-green-50 to-lime-50 px-6 py-5">
        <div class="mb-4 flex items-center gap-3">
          <mat-icon class="text-green-600 !text-[28px] !w-7 !h-7">lightbulb</mat-icon>
          <h5 class="m-0 text-base font-semibold text-green-700">Next Step: Suitability Verification</h5>
        </div>
        <div>
          <p class="mb-4 text-sm leading-relaxed text-slate-700">
            Before we show you alternative products, we need to <strong class="text-green-700">verify your client's current suitability profile</strong>. 
            This ensures that:
          </p>
          <div class="mb-4 flex flex-col gap-3">
            <div class="flex items-start gap-2.5">
              <mat-icon class="flex-shrink-0 text-green-500 !text-xl !w-5 !h-5">check_circle</mat-icon>
              <span class="flex-1 text-sm text-slate-700">Product recommendations match current client objectives and risk tolerance</span>
            </div>
            <div class="flex items-start gap-2.5">
              <mat-icon class="flex-shrink-0 text-green-500 !text-xl !w-5 !h-5">check_circle</mat-icon>
              <span class="flex-1 text-sm text-slate-700">AI scoring is based on up-to-date financial situation</span>
            </div>
            <div class="flex items-start gap-2.5">
              <mat-icon class="flex-shrink-0 text-green-500 !text-xl !w-5 !h-5">check_circle</mat-icon>
              <span class="flex-1 text-sm text-slate-700">Compliance requirements are met with documented suitability</span>
            </div>
          </div>
          @if (client?.suitability?.lastUpdated) {
            <div class="flex items-center gap-2 rounded-md border-l-[3px] border-orange-400 bg-orange-50/60 px-3.5 py-2.5">
              <mat-icon class="text-orange-600 !text-lg !w-[18px] !h-[18px]">schedule</mat-icon>
              <span class="text-[13px] text-slate-600">Client profile last updated: <strong class="text-orange-700">{{ client.suitability!.lastUpdated | date: 'MMM dd, yyyy' }}</strong></span>
            </div>
          }
        </div>
      </div>

      <div class="mt-6 flex flex-wrap items-center justify-between gap-3 border-t border-slate-200 pt-6">
        <button mat-raised-button color="primary" class="!px-7 !font-semibold" (click)="currentStep.set(1)">
          <mat-icon>fact_check</mat-icon>
          Review & Verify Suitability
        </button>
        <p class="m-0 w-full text-center text-xs italic text-slate-400">This will take ~2 minutes to review and confirm</p>
      </div>
    </div>
  }

  <!-- Step 2: Verify Client Suitability -->
  @if (currentStep() === 1) {
    <div class="px-8 py-6">
      <div class="mb-6 flex items-center gap-3">
        <mat-icon class="text-indigo-600 !text-[28px] !w-7 !h-7">person_search</mat-icon>
        <h4 class="m-0 text-lg font-semibold text-slate-800">Verify Client Suitability</h4>
      </div>

      <div class="mb-6 flex gap-5 rounded-lg border-2 border-indigo-600 bg-gradient-to-br from-indigo-50 to-blue-50 px-6 py-5">
        <div>
          <mat-icon class="text-indigo-700 !text-[40px] !w-10 !h-10">how_to_reg</mat-icon>
        </div>
        <div class="flex-1">
          <h5 class="m-0 mb-2 text-base font-semibold text-indigo-900">Review Current Profile</h5>
          <p class="m-0 mb-3 text-sm leading-relaxed text-slate-700">Please review and update the client's suitability profile below. Our AI will use this information to identify the most suitable replacement products.</p>
          @if (client?.suitability?.lastUpdated) {
            <p class="m-0 mt-2 flex items-center gap-1.5 text-[13px] text-slate-500">
              <mat-icon class="!text-base !w-4 !h-4">schedule</mat-icon>
              Last updated: <strong class="text-indigo-700">{{ client.suitability!.lastUpdated | date: 'MMM dd, yyyy' }}</strong>
            </p>
          }
          <div class="mt-3 flex items-center gap-2 rounded bg-indigo-500/10 px-3 py-2">
            <mat-icon class="text-indigo-600 !text-lg !w-[18px] !h-[18px]">error_outline</mat-icon>
            <span class="text-[13px] font-medium text-indigo-900">Action Required: Click "Verify Profile" below after reviewing</span>
          </div>
        </div>
      </div>

      <app-suitability-form 
        [client]="client"
        (suitabilityVerified)="onSuitabilityVerified()">
      </app-suitability-form>

      <div class="mt-6 flex flex-wrap items-center justify-between gap-3 border-t border-slate-200 pt-6">
        <button mat-button (click)="currentStep.set(0)">
          <mat-icon>arrow_back</mat-icon>
          Back to Why Flagged
        </button>
        <div class="flex items-center gap-3">
          @if (!canProceedToAlternatives()) {
            <div class="flex items-center gap-1.5 rounded bg-orange-50 px-3 py-1.5">
              <mat-icon class="text-orange-600 !text-lg !w-[18px] !h-[18px]">info</mat-icon>
              <span class="text-[13px] font-medium text-orange-700">Please verify the profile to continue</span>
            </div>
          }
          <button 
            mat-raised-button 
            color="primary"
            class="!px-7 !font-semibold"
            [disabled]="!canProceedToAlternatives()"
            (click)="onContinueToAlternatives()">
            <mat-icon>{{canProceedToAlternatives() ? 'analytics' : 'lock'}}</mat-icon>
            {{canProceedToAlternatives() ? 'Show AI-Matched Alternatives' : 'Verify Profile to Continue'}}
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Step 3: Market Alternatives -->
  @if (currentStep() === 2) {
    <div class="px-8 py-6">
      <div class="mb-6 flex items-center gap-3">
        <mat-icon class="text-indigo-600 !text-[28px] !w-7 !h-7">compare_arrows</mat-icon>
        <h4 class="m-0 text-lg font-semibold text-slate-800">Market Alternatives</h4>
      </div>

      @if (loadingAlternatives()) {
        <div class="flex flex-col items-center py-16">
          <mat-spinner diameter="40"></mat-spinner>
          <p class="mt-4 text-slate-500">Finding suitable alternatives based on verified suitability profile...</p>
        </div>
      } @else {
        <div>
          <!-- Compliance Disclaimer -->
          <div class="mb-6 flex gap-3 rounded-lg border-2 border-orange-500 bg-orange-50 px-5 py-4">
            <mat-icon class="flex-shrink-0 text-orange-500 !text-2xl !w-6 !h-6">warning</mat-icon>
            <div class="flex-1 text-sm leading-relaxed text-slate-700">
              <strong class="text-orange-700">Important:</strong> These are illustrative alternatives only â€” not a recommendation. 
              Based on suitability profile as of 
              {{ client?.suitability?.lastUpdated | date: 'MMM dd, yyyy h:mm a' }}.
              Full suitability analysis required before any recommendation.
            </div>
          </div>

          <!-- Side-by-Side Comparison Table -->
          <div class="mb-8 overflow-x-auto rounded-lg border border-slate-200 shadow-sm">
            <table class="w-full border-collapse">
              <thead class="bg-slate-50">
                <tr>
                  <th class="w-1/4 border-b-2 border-slate-200 px-3 py-4 text-left text-sm font-semibold text-slate-700">Feature</th>
                  <th class="border-b-2 border-slate-200 px-3 py-4 text-left">
                    <div class="flex flex-col gap-2">
                      <span class="text-sm font-semibold text-slate-700">Current Policy</span>
                      <mat-chip class="!h-[22px] !min-h-[22px] !bg-slate-200 !px-2 !text-[11px] !text-slate-600">Current</mat-chip>
                    </div>
                  </th>
                  @for (alt of alternatives(); track alt.productId; let idx = $index) {
                    <th class="border-b-2 border-slate-200 px-3 py-4 text-left">
                      <div class="flex flex-col gap-2">
                        <span class="text-sm font-semibold text-slate-700">Alternative {{ idx + 1 }}</span>
                        <mat-chip class="!h-[22px] !min-h-[22px] !bg-green-500 !px-2 !text-[11px] !text-white">
                          {{ alt.suitabilityScore }}% Match
                        </mat-chip>
                      </div>
                    </th>
                  }
                </tr>
              </thead>
              <tbody>
                @for (row of getComparisonData(); track row.feature) {
                  <tr class="border-b border-slate-100 transition-colors hover:bg-slate-50" [ngClass]="{'bg-indigo-50': row.highlight}">
                    <td class="px-3 py-3 text-sm font-medium text-slate-500">{{ row.feature }}</td>
                    <td class="px-3 py-3 text-sm font-medium text-slate-700">{{ row.current }}</td>
                    @for (alt of alternatives(); track alt.productId; let idx = $index) {
                      <td class="px-3 py-3 text-sm" [ngClass]="row.highlight === 'rate' && row['alt' + (idx + 1)] > row.current ? 'font-semibold text-green-700' : 'text-slate-700'">
                        {{ row['alt' + (idx + 1)] }}
                        @if (row.highlight === 'rate' && row['alt' + (idx + 1)] > row.current) {
                          <mat-icon class="ml-1 align-middle text-green-500 !text-lg !w-[18px] !h-[18px]">trending_up</mat-icon>
                        }
                      </td>
                    }
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Performance & Rates Charts -->
          <app-performance-charts
            [currentPolicyName]="policy.productName || (policy.carrier + ' ' + policy.productType)"
            [currentCapRate]="policy.currentCapRate || 0"
            [currentAccountValue]="policy.accountValue || 150000"
            [alternatives]="alternatives()"
            [incomeGoal]="70000">
          </app-performance-charts>

          <!-- Alternative Highlights -->
          <div class="mb-6 mt-10 grid grid-cols-[repeat(auto-fit,minmax(280px,1fr))] gap-5">
            <!-- Renewal Option (Current Policy) -->
            <div class="cursor-pointer rounded-xl border-2 p-5 transition-all duration-300"
                 [ngClass]="selectedAlternativeId() === 'renewal' ? 'border-indigo-500 bg-indigo-50/50 shadow-lg ring-2 ring-indigo-300' : 'border-indigo-200 bg-indigo-50/30 hover:border-indigo-400 hover:shadow-lg'"
                 (click)="onSelectOption('renewal')">
              <div class="mb-3 flex items-start gap-3">
                <mat-radio-button [value]="'renewal'" [checked]="selectedAlternativeId() === 'renewal'" class="mt-0.5" (change)="onSelectOption('renewal')"></mat-radio-button>
                <div class="flex-1">
                  <div class="mb-2">
                    <span class="inline-flex items-center gap-1.5 rounded-full bg-indigo-100 px-3 py-1 text-[12px] font-bold text-indigo-700">
                      <mat-icon class="!text-[14px] !w-3.5 !h-3.5">autorenew</mat-icon>
                      Renewal
                    </span>
                  </div>
                  <h5 class="m-0 mb-3 text-base font-bold leading-snug text-slate-800">{{ getRenewalOption().optionTitle }}</h5>

                  <div class="mb-3">
                    <p class="m-0 mb-2 text-[13px] font-bold text-slate-700">Key Benefits:</p>
                    @for (benefit of getRenewalOption().keyBenefits; track benefit) {
                      <div class="mb-1.5 flex items-start gap-2">
                        <span class="mt-1.5 inline-block h-1.5 w-1.5 flex-shrink-0 rounded-full bg-slate-400"></span>
                        <span class="text-[13px] leading-relaxed text-slate-600">{{ benefit }}</span>
                      </div>
                    }
                  </div>

                  <div>
                    <p class="m-0 mb-2 text-[13px] font-bold text-slate-700">Considerations:</p>
                    @for (consideration of getRenewalOption().considerations; track consideration) {
                      <div class="mb-1.5 flex items-start gap-2">
                        <span class="mt-1.5 inline-block h-1.5 w-1.5 flex-shrink-0 rounded-full bg-slate-400"></span>
                        <span class="text-[13px] leading-relaxed text-slate-600">{{ consideration }}</span>
                      </div>
                    }
                  </div>
                </div>
              </div>
            </div>

            <!-- Replacement Alternatives -->
            @for (alt of alternatives(); track alt.productId; let idx = $index) {
              <div 
                class="rounded-xl border-2 p-5 transition-all duration-300"
                [ngClass]="selectedAlternativeId() === alt.productId 
                  ? 'cursor-pointer border-indigo-500 bg-indigo-50/50 shadow-lg ring-2 ring-indigo-300' 
                  : alt.canSell === false 
                    ? 'border-orange-300 bg-orange-50/30 opacity-70' 
                    : 'cursor-pointer border-slate-200 hover:border-indigo-500 hover:shadow-lg'"
                (click)="alt.canSell !== false && onSelectOption(alt.productId)"
                (mouseenter)="onAlternativeHover(alt)"
                (mouseleave)="onAlternativeLeave()">
                <div class="mb-3 flex items-start gap-3">
                  @if (alt.canSell !== false) {
                    <mat-radio-button [value]="alt.productId" [checked]="selectedAlternativeId() === alt.productId" class="mt-0.5" (change)="onSelectOption(alt.productId)"></mat-radio-button>
                  }
                  <div class="flex-1">
                    <div class="mb-2 flex items-center justify-between">
                      <span class="inline-flex items-center gap-1.5 rounded-full bg-indigo-100 px-3 py-1 text-[12px] font-bold text-indigo-700">
                        <mat-icon class="!text-[14px] !w-3.5 !h-3.5">swap_horiz</mat-icon>
                        Replacement
                      </span>
                      <div class="flex gap-1.5">
                        <mat-chip class="!flex !h-7 !min-h-[28px] !min-w-[28px] !items-center !justify-center !rounded-full !p-0 !text-[11px] !font-semibold"
                                  [ngClass]="alt.hasLicense ? '!bg-green-500 !text-white' : '!bg-slate-200 !text-slate-400'"
                                  matTooltip="License {{ alt.hasLicense ? 'Active' : 'Required' }}">L</mat-chip>
                        <mat-chip class="!flex !h-7 !min-h-[28px] !min-w-[28px] !items-center !justify-center !rounded-full !p-0 !text-[11px] !font-semibold"
                                  [ngClass]="alt.hasAppointment ? '!bg-green-500 !text-white' : '!bg-slate-200 !text-slate-400'"
                                  matTooltip="Appointment {{ alt.hasAppointment ? 'Active' : 'Required' }}">A</mat-chip>
                        <mat-chip class="!flex !h-7 !min-h-[28px] !min-w-[28px] !items-center !justify-center !rounded-full !p-0 !text-[11px] !font-semibold"
                                  [ngClass]="alt.hasTraining ? '!bg-green-500 !text-white' : '!bg-slate-200 !text-slate-400'"
                                  matTooltip="Training {{ alt.hasTraining ? 'Complete' : 'Required' }}">T</mat-chip>
                      </div>
                    </div>

                    <h5 class="m-0 mb-3 text-base font-bold leading-snug text-slate-800">{{ alt.optionTitle }}</h5>

                    <!-- Can Sell / Cannot Sell Badge -->
                    @if (alt.canSell === false) {
                      <div class="mb-3 inline-flex items-center gap-1.5 rounded-full bg-orange-50 px-3 py-1.5 text-[13px] font-semibold text-orange-700">
                        <mat-icon class="text-orange-500 !text-lg !w-[18px] !h-[18px]">cancel</mat-icon>
                        <span>Cannot Sell</span>
                      </div>
                    }

                    <!-- Compliance Notes -->
                    @if (alt.complianceNotes && alt.canSell === false) {
                      <div class="mb-3 flex gap-2.5 rounded-lg border border-amber-300 bg-orange-50 p-3">
                        <mat-icon class="flex-shrink-0 text-orange-500 !text-xl !w-5 !h-5">warning</mat-icon>
                        <p class="m-0 text-[13px] leading-relaxed text-orange-700">{{ alt.complianceNotes }}</p>
                      </div>
                    }

                    <div class="mb-3">
                      <p class="m-0 mb-2 text-[13px] font-bold text-slate-700">Key Benefits:</p>
                      @for (benefit of alt.keyBenefits; track benefit) {
                        <div class="mb-1.5 flex items-start gap-2">
                          <span class="mt-1.5 inline-block h-1.5 w-1.5 flex-shrink-0 rounded-full bg-slate-400"></span>
                          <span class="text-[13px] leading-relaxed text-slate-600">{{ benefit }}</span>
                        </div>
                      }
                    </div>

                    <div>
                      <p class="m-0 mb-2 text-[13px] font-bold text-slate-700">Considerations:</p>
                      @for (consideration of alt.considerations; track consideration) {
                        <div class="mb-1.5 flex items-start gap-2">
                          <span class="mt-1.5 inline-block h-1.5 w-1.5 flex-shrink-0 rounded-full bg-slate-400"></span>
                          <span class="text-[13px] leading-relaxed text-slate-600">{{ consideration }}</span>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>

          <!-- AI Documentation Section (appears when a product is selected) -->
          @if (selectedAlternativeId()) {
            <div class="mb-6 mt-2 rounded-xl border-2 border-indigo-300 bg-white p-6 shadow-sm transition-all duration-500">
              <div class="mb-5 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-indigo-100">
                    <mat-icon class="text-indigo-600 !text-2xl !w-6 !h-6">description</mat-icon>
                  </div>
                  <div>
                    <h4 class="m-0 text-base font-bold text-slate-800">Documentation</h4>
                    <p class="m-0 text-[13px] text-slate-500">Auto-generated summary</p>
                  </div>
                </div>
                <span class="rounded-full border border-amber-400 bg-amber-50 px-3 py-1 text-[12px] font-bold text-amber-700">Required</span>
              </div>

              <!-- Summary -->
              <div class="mb-4">
                <div class="mb-2 flex items-center justify-between">
                  <p class="m-0 text-sm font-bold text-slate-700">Summary</p>
                  <div class="flex items-center gap-1.5 text-slate-400">
                    <mat-icon class="!text-base !w-4 !h-4">info</mat-icon>
                    <span class="text-[12px]">Auto-generated</span>
                  </div>
                </div>
                @if (generatingDocumentation()) {
                  <div class="flex items-center gap-3 rounded-lg bg-slate-50 px-5 py-6">
                    <mat-spinner diameter="20"></mat-spinner>
                    <span class="text-sm text-slate-500">Generating AI documentation...</span>
                  </div>
                } @else {
                  <div class="rounded-lg bg-slate-50 px-5 py-4">
                    <p class="m-0 text-sm leading-relaxed text-slate-700">{{ documentationSummary() }}</p>
                  </div>
                }
              </div>

              <!-- Info Note -->
              <div class="mb-5 flex items-center gap-3 rounded-lg border border-indigo-200 bg-indigo-50/50 px-4 py-3">
                <mat-icon class="text-indigo-500 !text-xl !w-5 !h-5">info</mat-icon>
                <span class="text-[13px] text-slate-600">Documentation will be automatically attached to the application submission.</span>
              </div>

              <!-- Confirm Documentation Button -->
              @if (!documentationConfirmed()) {
                <button 
                  mat-raised-button 
                  class="!w-full !rounded-xl !bg-indigo-600 !py-3 !text-base !font-semibold !text-white hover:!bg-indigo-700"
                  [disabled]="generatingDocumentation()"
                  (click)="onConfirmDocumentation()">
                  Confirm Documentation
                  <mat-icon class="ml-1">chevron_right</mat-icon>
                </button>
              } @else {
                <div class="flex items-center gap-2 rounded-lg bg-green-50 px-4 py-3">
                  <mat-icon class="text-green-600 !text-xl !w-5 !h-5">check_circle</mat-icon>
                  <span class="text-sm font-semibold text-green-700">Documentation confirmed</span>
                </div>
              }
            </div>
          }
        </div>

        <div class="mt-6 flex flex-wrap items-center justify-between gap-3 border-t border-slate-200 pt-6">
          <button mat-button (click)="currentStep.set(1)">
            <mat-icon>arrow_back</mat-icon>
            Back to Suitability
          </button>
          <div class="flex items-center gap-3">
            <button 
              mat-raised-button 
              color="accent" 
              class="!flex !items-center !gap-2 !font-medium"
              (click)="exportToPDF()"
              [disabled]="exportingPDF()"
              matTooltip="Export complete replacement analysis to PDF">
              <mat-icon>picture_as_pdf</mat-icon>
              @if (exportingPDF()) {
                <span>Generating PDF...</span>
              } @else {
                <span>Export Analysis to PDF</span>
              }
            </button>
            <button 
              mat-raised-button 
              color="primary"
              class="!flex !items-center !gap-2 !rounded-xl !px-8 !py-2 !text-base !font-semibold"
              [disabled]="!selectedAlternativeId() || !documentationConfirmed()"
              (click)="onContinue()"
              [matTooltip]="!selectedAlternativeId() ? 'Select an option above' : !documentationConfirmed() ? 'Confirm documentation first' : 'Continue with selected option'">
              <span>Continue</span>
              <mat-icon>chevron_right</mat-icon>
            </button>
          </div>
        </div>
      }
    </div>
  }
</div>
