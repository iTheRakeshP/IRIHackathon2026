<div class="relative flex h-[95vh] w-[95vw] max-w-[1400px] flex-col overflow-hidden rounded-2xl bg-white/[0.98] shadow-2xl backdrop-blur-xl">

  <!-- Modal Header -->
  <div class="flex min-h-[70px] items-center justify-between bg-gradient-to-br from-indigo-500 to-purple-700 px-7 py-5 text-white shadow-lg">
    <div class="flex flex-1 items-center">
      @if (client(); as clientData) {
        <div class="flex flex-wrap items-center gap-4">
          <div class="flex items-center gap-2.5">
            <span class="text-xl font-bold drop-shadow-sm">{{ clientData.name }}</span>
            <span class="text-sm opacity-70">&bull;</span>
            <span class="text-sm font-medium opacity-95">{{ clientData.clientAccountNumber }}</span>
          </div>
          @if (policy(); as policyData) {
            <span class="mx-1.5 text-xl opacity-50">|</span>
            <div class="flex items-center gap-2.5">
              <span class="text-[17px] font-semibold">{{ policyData.carrier }} {{ policyData.productType }}</span>
              <span class="text-sm opacity-70">&bull;</span>
              <span class="text-[13px] opacity-90">{{ policyData.policyId }}</span>
            </div>
          }
        </div>
      } @else {
        <div class="h-5 w-52 animate-pulse rounded bg-white/20"></div>
      }
    </div>
    <div class="flex items-center gap-3.5">
      <button (click)="onOpenAICopilot()"
              class="inline-flex items-center gap-2 rounded-lg bg-white/20 px-4 py-2 text-sm font-semibold text-white backdrop-blur-sm transition hover:bg-white/30 hover:-translate-y-0.5 hover:shadow-lg">
        <mat-icon class="!text-[20px] !w-5 !h-5">psychology</mat-icon>
        PolicyPilot
      </button>
      <button mat-icon-button (click)="onClose()" aria-label="Close modal" class="!text-white transition hover:scale-110 hover:bg-white/20">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <!-- Modal Body -->
  <div class="flex-1 overflow-y-auto">
    @if (loading()) {
      <div class="flex flex-col items-center justify-center py-16">
        <mat-spinner diameter="50"></mat-spinner>
        <p class="mt-4 text-slate-500">Loading policy details...</p>
      </div>
    } @else {
      <!-- Current Policy Overview -->
      <section class="bg-slate-50 px-8 py-6">
        <h3 class="mb-5 flex items-center gap-2 text-lg font-semibold text-slate-800">
          <mat-icon class="!text-[20px] !w-5 !h-5 text-indigo-600">description</mat-icon>
          Current Policy Overview
        </h3>
        @if (policy(); as policyData) {
          <app-policy-overview [policy]="policyData"></app-policy-overview>
        }
      </section>

      <div class="h-px bg-slate-200"></div>

      <!-- Active Alerts Panel -->
      <section class="px-8 py-6">
        <h3 class="mb-5 flex items-center gap-2 text-lg font-semibold text-slate-800">
          <mat-icon class="!text-[20px] !w-5 !h-5 text-indigo-600">notifications_active</mat-icon>
          Active Alerts
          <span class="ml-1 text-sm font-normal text-slate-400">({{ sortedAlerts().length }})</span>
        </h3>

        <div class="flex flex-col gap-3">
          @for (alert of sortedAlerts(); track alert.alertId) {
            <div
              class="flex cursor-pointer items-center gap-4 rounded-lg border-2 bg-white px-5 py-4 transition hover:translate-x-1 hover:border-indigo-500 hover:bg-indigo-50/30"
              [class.bg-indigo-50]="isAlertExpanded(alert.alertId)"
              [class.border-indigo-500]="isAlertExpanded(alert.alertId)"
              [class.shadow-md]="isAlertExpanded(alert.alertId)"
              [ngClass]="{
                'border-l-4 !border-l-red-500': getAlertSeverityClass(alert.severity) === 'high',
                'border-l-4 !border-l-amber-500': getAlertSeverityClass(alert.severity) === 'medium',
                'border-l-4 !border-l-yellow-400': getAlertSeverityClass(alert.severity) === 'low'
              }"
              (click)="onAlertPillClick(alert)">
              <mat-icon class="!text-[28px] !w-7 !h-7 text-indigo-600">{{ getAlertIcon(alert.type) }}</mat-icon>
              <div class="flex flex-1 flex-col gap-1">
                <span class="text-base font-semibold text-slate-800">{{ alert.title }}</span>
                <span class="text-sm text-slate-500">{{ alert.reasonShort }}</span>
              </div>
              <mat-icon class="text-slate-400">
                {{ isAlertExpanded(alert.alertId) ? 'expand_less' : 'expand_more' }}
              </mat-icon>
            </div>
          } @empty {
            <div class="flex flex-col items-center py-10 text-slate-400">
              <mat-icon class="!text-[48px] !w-12 !h-12 mb-3 text-green-500">check_circle</mat-icon>
              <p>No active alerts</p>
            </div>
          }
        </div>
      </section>

      <div class="h-px bg-slate-200"></div>

      <!-- Alert Action & Analysis -->
      @if (expandedAlertId()) {
        <section class="min-h-[200px] px-8 py-6" #reviewModulesSection>
          <h3 class="mb-5 flex items-center gap-2 text-lg font-semibold text-slate-800">
            <mat-icon class="!text-[20px] !w-5 !h-5 text-indigo-600">fact_check</mat-icon>
            Alert Action & Analysis
          </h3>

          <div>
            @for (alert of sortedAlerts(); track alert.alertId) {
              <div class="mb-4 overflow-hidden rounded-lg" [class.animate-[expandModule_0.3s_ease]]="isAlertExpanded(alert.alertId)">
                @if (isAlertExpanded(alert.alertId)) {
                  @if (alert.type === 'REPLACEMENT') {
                    <app-replacement-module
                      [alert]="alert"
                      [policy]="policy()!"
                      [client]="client()!"
                      (actionComplete)="onModuleActionComplete($event)">
                    </app-replacement-module>
                  }
                  @if (alert.type === 'INCOME_ACTIVATION') {
                    <app-income-activation-module
                      [alert]="alert"
                      [policy]="policy()!"
                      [client]="client()!"
                      (actionComplete)="onModuleActionComplete($event)">
                    </app-income-activation-module>
                  }
                  @if (alert.type === 'SUITABILITY_DRIFT') {
                    <app-suitability-drift-module
                      [alert]="alert"
                      [policy]="policy()!"
                      [client]="client()!"
                      (actionComplete)="onModuleActionComplete($event)">
                    </app-suitability-drift-module>
                  }
                  @if (alert.type === 'MISSING_INFO') {
                    <app-missing-info-module
                      [alert]="alert"
                      [policy]="policy()!"
                      [client]="client()!"
                      (actionComplete)="onModuleActionComplete($event)">
                    </app-missing-info-module>
                  }
                }
              </div>
            } @empty {
              <div class="py-10 text-center text-slate-400">
                <p>Select an alert to view review details</p>
              </div>
            }
          </div>

          <!-- Bottom Navigation -->
          <div class="mt-8 flex items-center justify-center border-t border-slate-200 pt-6">
            <button (click)="onCloseModule()"
                    class="inline-flex items-center gap-2 rounded-lg border-2 border-indigo-400/50 px-7 py-2.5 text-sm font-semibold text-indigo-500 transition hover:-translate-x-1 hover:border-indigo-500 hover:bg-indigo-50 hover:shadow-md">
              <mat-icon class="!text-[20px] !w-5 !h-5">arrow_back</mat-icon>
              Back to Alerts
            </button>
          </div>
        </section>
      }
    }
  </div>

  <!-- AI Chat Drawer (inside modal, absolute positioned) -->
  <app-ai-chat-drawer></app-ai-chat-drawer>
</div>
